generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["views"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  MANAGER
  EMPLOYEE
}

enum MediaStatus {
  PENDING_UPLOAD
  READY
  PROCESSING
  OPTIMIZED
  FAILED
}

enum StockLedgerType {
  INITIAL_COUNT
  ADJUSTMENT
  RECEIPT
  SALE
}

enum PurchaseOrderStatus {
  DRAFT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum InventoryImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  passwordHash  String
  firstName     String
  lastName      String
  role          Role           @default(EMPLOYEE)
  refreshTokens RefreshToken[]
  stockLedgerEntries StockLedger[] @relation("UserStockLedgerEntries")
  sales         Sale[]         @relation("SalesRecordedByUser")
  inventoryImports InventoryImportBatch[] @relation("InventoryImportsUploadedBy")
  purchaseOrders   PurchaseOrder[]        @relation("PurchaseOrdersCreatedBy")
  goodsReceipts    GoodsReceipt[]         @relation("GoodsReceiptsReceivedBy")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Brand {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  searchVector Unsupported("tsvector")?
}

model Product {
  id          String    @id @default(uuid())
  name        String
  description String?
  category    String?
  tags        String[]  @default([])
  brandId     String
  brand       Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  variants    Variant[]
  media       Media[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  searchVector Unsupported("tsvector")?

  @@index([brandId])
}

model Variant {
  id          String        @id @default(uuid())
  productId   String
  product     Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku         String        @unique
  size        String?
  color       String?
  priceCents  Int?
  costPriceCents Int?
  barcode     String?
  stockLedger StockLedger[]
  purchaseOrderItems PurchaseOrderItem[]
  media       Media[]
  saleItems   SaleItem[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([productId])
  @@index([sku])
}

model StockLedger {
  id             String          @id @default(uuid())
  variantId      String
  variant        Variant         @relation(fields: [variantId], references: [id], onDelete: Cascade)
  recordedById   String?
  recordedBy     User?           @relation("UserStockLedgerEntries", fields: [recordedById], references: [id], onDelete: SetNull)
  quantityChange Int
  type           StockLedgerType
  reason         String?
  reference      String?
  createdAt      DateTime        @default(now())

  @@index([variantId])
  @@index([recordedById])
}

model InventoryImportBatch {
  id               String                 @id @default(uuid())
  status           InventoryImportStatus  @default(PENDING)
  uploadedById     String
  uploadedBy       User                   @relation("InventoryImportsUploadedBy", fields: [uploadedById], references: [id], onDelete: Cascade)
  originalFileName String
  totalRows        Int
  processedRows    Int                    @default(0)
  chunkSize        Int                    @default(200)
  failureReason    String?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  logs             InventoryImportAuditLog[]

  @@index([uploadedById])
}

model InventoryImportAuditLog {
  id        String                @id @default(uuid())
  batchId   String
  batch     InventoryImportBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)
  level     String
  message   String
  metadata  Json?
  createdAt DateTime              @default(now())

  @@index([batchId])
}

model Sale {
  id                  String    @id @default(uuid())
  recordedById        String?
  recordedBy          User?     @relation("SalesRecordedByUser", fields: [recordedById], references: [id], onDelete: SetNull)
  subtotalCents       Int
  saleDiscountCents   Int        @default(0)
  discountTotalCents  Int        @default(0)
  taxTotalCents       Int        @default(0)
  totalCents          Int
  paymentBreakdown    Json
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  items               SaleItem[]

  @@index([recordedById])
}

model SaleItem {
  id              String   @id @default(uuid())
  saleId          String
  sale            Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  variantId       String
  variant         Variant  @relation(fields: [variantId], references: [id], onDelete: Restrict)
  quantity        Int
  unitPriceCents  Int
  discountCents   Int      @default(0)
  createdAt       DateTime @default(now())

  @@index([saleId])
  @@index([variantId])
}

model Supplier {
  id        String           @id @default(uuid())
  name      String
  contact   String?
  email     String?
  phone     String?
  address   String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  purchaseOrders PurchaseOrder[]
}

model PurchaseOrder {
  id           String               @id @default(uuid())
  supplierId   String
  supplier     Supplier             @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  createdById  String
  createdBy    User                 @relation("PurchaseOrdersCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  status       PurchaseOrderStatus  @default(DRAFT)
  orderedAt    DateTime?            
  receivedAt   DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  items        PurchaseOrderItem[]
  receipts     GoodsReceipt[]

  @@index([supplierId])
  @@index([createdById])
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  variantId       String
  variant         Variant       @relation(fields: [variantId], references: [id], onDelete: Restrict)
  quantityOrdered Int
  quantityReceived Int          @default(0)
  costCents       Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  receiptItems    GoodsReceiptItem[]

  @@index([purchaseOrderId])
  @@index([variantId])
}

model GoodsReceipt {
  id              String            @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder     @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  receivedById    String?
  receivedBy      User?             @relation("GoodsReceiptsReceivedBy", fields: [receivedById], references: [id], onDelete: SetNull)
  receivedAt      DateTime          @default(now())
  createdAt       DateTime          @default(now())
  items           GoodsReceiptItem[]

  @@index([purchaseOrderId])
  @@index([receivedById])
}

model GoodsReceiptItem {
  id              String        @id @default(uuid())
  goodsReceiptId  String
  goodsReceipt    GoodsReceipt  @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  purchaseOrderItemId String
  purchaseOrderItem PurchaseOrderItem @relation(fields: [purchaseOrderItemId], references: [id], onDelete: Cascade)
  quantityReceived Int
  costCents        Int?
  createdAt        DateTime      @default(now())

  @@index([goodsReceiptId])
  @@index([purchaseOrderItemId])
}

model Media {
  id             String      @id @default(uuid())
  productId      String?
  product        Product?    @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId      String?
  variant        Variant?    @relation(fields: [variantId], references: [id], onDelete: Cascade)
  bucket         String
  key            String
  fileName       String
  contentType    String
  sizeBytes      Int?
  status         MediaStatus @default(PENDING_UPLOAD)
  optimizedKey   String?
  uploadExpiresAt DateTime?
  uploadedAt     DateTime?
  optimizedAt    DateTime?
  originalDeletedAt DateTime?
  failureReason  String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([productId])
  @@index([variantId])
}

model Setting {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

view CurrentStock {
  variantId  String @map("variant_id")
  productId  String @map("product_id")
  brandId    String @map("brand_id")
  onHand     Int    @map("on_hand")
  sku        String
  brandName  String @map("brand_name")
  productName String @map("product_name")
  category   String?
  size       String?
  color      String?
  tags       String[]
  priceCents Int?   @map("price_cents")

  @@map("current_stock")
}

view DailySalesTotals {
  saleDate           DateTime @map("sale_date")
  grossSalesCents    Int      @map("gross_sales_cents")
  discountTotalCents Int      @map("discount_total_cents")
  taxTotalCents      Int      @map("tax_total_cents")
  netSalesCents      Int      @map("net_sales_cents")
  saleCount          Int      @map("sale_count")

  @@map("daily_sales_totals")
}

view SaleItemDailyMetrics {
  saleDate           DateTime @map("sale_date")
  variantId          String   @map("variant_id")
  productId          String   @map("product_id")
  brandId            String   @map("brand_id")
  sku                String
  productName        String   @map("product_name")
  brandName          String   @map("brand_name")
  quantitySold       Int      @map("quantity_sold")
  grossSalesCents    Int      @map("gross_sales_cents")
  discountTotalCents Int      @map("discount_total_cents")
  netSalesCents      Int      @map("net_sales_cents")
  lastSoldAt         DateTime @map("last_sold_at")

  @@map("sale_item_daily_metrics")
}

view BrandDailyMetrics {
  saleDate           DateTime @map("sale_date")
  brandId            String   @map("brand_id")
  brandName          String   @map("brand_name")
  quantitySold       Int      @map("quantity_sold")
  grossSalesCents    Int      @map("gross_sales_cents")
  discountTotalCents Int      @map("discount_total_cents")
  netSalesCents      Int      @map("net_sales_cents")

  @@map("brand_daily_metrics")
}

view LowStockVariants {
  variantId   String @map("variant_id")
  productId   String @map("product_id")
  brandId     String @map("brand_id")
  sku         String
  productName String @map("product_name")
  brandName   String @map("brand_name")
  onHand      Int    @map("on_hand")
  threshold   Int

  @@map("low_stock_variants")
}
